<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IT Ops Task Generator (Realtime)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // --- Firebase Config (yours) ---
    const firebaseConfig = {
      apiKey: "AIzaSyC56asNTd04xhDU4OlnBHS4zNxj_aiiFhM",
      authDomain: "activity-log-275ce.firebaseapp.com",
      databaseURL: "https://activity-log-275ce-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "activity-log-275ce",
      storageBucket: "activity-log-275ce.firebasestorage.app",
      messagingSenderId: "436390670385",
      appId: "1:436390670385:web:a4e4bf77c32d4061c76510"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Members ---
    const members = {
      "IRO": "Ian Romero",
      "RDE": "Rhizza De Guzman",
      "FFA": "Felix Factor",
      "NLA": "Nathan Lapena",
      "MAG": "Michael Henry Aglubat",
      "JMA": "Jelyn Malubay"
    };

    let taskPool = [
      "PW", "ARC", "Loglogic", "TM1Top", "ISMS", "CRITICAL",
      "PROXY", "HO", "EMEA Ticket", "TO", "Remind AX"
    ];

    // --- DAILY TASKS ---
    function renderDailyTasks() {
      const container = document.getElementById("dailyTasksList");
      container.innerHTML = "";
      taskPool.forEach(task => {
        const row = document.createElement("div");
        row.className = "flex items-center space-x-2";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "form-checkbox";
        checkbox.dataset.task = task;
        checkbox.onchange = () => saveDailyTask(task, checkbox.checked);

        const label = document.createElement("span");
        label.textContent = task;

        const dropdown = document.createElement("select");
        dropdown.className = "border rounded-lg p-1";
        dropdown.dataset.task = task;
        dropdown.innerHTML = `<option value="">-- Select Member --</option>` +
          Object.entries(members).map(([k,v]) => `<option value="${k}">${k} (${v})</option>`).join("");
        dropdown.onchange = () => saveDailyTask(task, checkbox.checked, dropdown.value);

        row.appendChild(checkbox);
        row.appendChild(label);
        row.appendChild(dropdown);
        container.appendChild(row);
      });
    }

    function saveDailyTask(task, checked, member="") {
      update(ref(db, "dailyTasks/" + task), {
        checked: checked,
        member: member || ""
      });
    }

    function listenDailyTasks() {
      onValue(ref(db, "dailyTasks"), snapshot => {
        const data = snapshot.val() || {};
        document.querySelectorAll("#dailyTasksList div").forEach(row => {
          const cb = row.querySelector("input[type=checkbox]");
          const dd = row.querySelector("select");
          const t = cb.dataset.task;
          if (data[t]) {
            cb.checked = data[t].checked;
            dd.value = data[t].member || "";
          }
        });
      });
    }

    // --- WEEKLY & MONTHLY ---
    function saveWeeklyMonthly() {
      update(ref(db), {
        weekly: document.getElementById("weeklyTasks").value,
        monthly: document.getElementById("monthlyTasks").value
      });
    }

    function listenWeeklyMonthly() {
      onValue(ref(db), snapshot => {
        const data = snapshot.val() || {};
        document.getElementById("weeklyTasks").value = data.weekly || "";
        document.getElementById("monthlyTasks").value = data.monthly || "";
      });
    }

    // --- MONITORING ---
    function saveMonitoring(slot, member) {
      update(ref(db, "monitoring/" + slot), { member });
    }

    function listenMonitoring() {
      onValue(ref(db, "monitoring"), snapshot => {
        const data = snapshot.val() || {};
        document.querySelectorAll("#autoMonitoringSlots select, #manualMonitoringSlots select").forEach(sel => {
          if (data[sel.dataset.slot]) {
            sel.value = data[sel.dataset.slot].member || "";
          }
        });
      });
    }

    // Generate auto monitoring slots
    function generateMonitoring() {
      const start = document.getElementById("startTime").value;
      const end = document.getElementById("endTime").value;
      const count = parseInt(document.getElementById("teamCount").value);
      const slotsDiv = document.getElementById("autoMonitoringSlots");
      slotsDiv.innerHTML = "";

      const [sh,sm] = start.split(":"), [eh,em] = end.split(":");
      let cur = new Date(); cur.setHours(sh,sm);
      let endDate = new Date(); endDate.setHours(eh,em);
      const total = (endDate - cur) / 60000;
      const slotMins = total / count;

      for (let i=0;i<count;i++) {
        let s = new Date(cur);
        cur.setMinutes(cur.getMinutes()+slotMins);
        let e = new Date(cur);
        const slotLabel = `${formatTime(s)} - ${formatTime(e)}`;

        const row = document.createElement("div");
        row.className = "flex items-center space-x-2";
        const label = document.createElement("span");
        label.textContent = slotLabel;

        const dropdown = document.createElement("select");
        dropdown.className = "border rounded-lg p-1";
        dropdown.dataset.slot = slotLabel;
        dropdown.innerHTML = `<option value="">-- Select Member --</option>` +
          Object.entries(members).map(([k,v]) => `<option value="${k}">${k} (${v})</option>`).join("");
        dropdown.onchange = () => saveMonitoring(slotLabel, dropdown.value);

        row.appendChild(label);
        row.appendChild(dropdown);
        slotsDiv.appendChild(row);
      }
    }

    function formatTime(date) {
      let h = date.getHours(), m = date.getMinutes();
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12 || 12;
      return h + ":" + (m<10?"0":"") + m + " " + ampm;
    }

    // Manual monitoring
    function generateManualMonitoring() {
      const slots = document.getElementById("manualMonitoring").value.split("\n").map(s=>s.trim()).filter(s=>s);
      const container = document.getElementById("manualMonitoringSlots");
      container.innerHTML = "";
      slots.forEach(slot => {
        const row = document.createElement("div");
        row.className = "flex items-center space-x-2";
        const label = document.createElement("span");
        label.textContent = slot;
        const dropdown = document.createElement("select");
        dropdown.className = "border rounded-lg p-1";
        dropdown.dataset.slot = slot;
        dropdown.innerHTML = `<option value="">-- Select Member --</option>` +
          Object.entries(members).map(([k,v]) => `<option value="${k}">${k} (${v})</option>`).join("");
        dropdown.onchange = () => saveMonitoring(slot, dropdown.value);
        row.appendChild(label);
        row.appendChild(dropdown);
        container.appendChild(row);
      });
    }

    // --- RESET ---
    function resetAll() {
      if (confirm("Reset everything for new day?")) {
        remove(ref(db, "dailyTasks"));
        remove(ref(db, "monitoring"));
        update(ref(db), { weekly: "", monthly: "" });
      }
    }

    // --- Init ---
    window.addEventListener("DOMContentLoaded", () => {
      renderDailyTasks();
      listenDailyTasks();
      listenWeeklyMonthly();
      listenMonitoring();

      document.getElementById("weeklyTasks").addEventListener("input", saveWeeklyMonthly);
      document.getElementById("monthlyTasks").addEventListener("input", saveWeeklyMonthly);
      document.getElementById("resetBtn").addEventListener("click", resetAll);
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-2xl p-6">
    <h1 class="text-2xl font-bold text-center mb-6">IT Ops Task Generator (Realtime)</h1>

    <!-- Daily Tasks -->
    <div class="mb-6 p-4 border rounded-xl shadow-sm">
      <h2 class="text-xl font-semibold mb-3 text-blue-700">Daily Tasks</h2>
      <div id="dailyTasksList" class="space-y-2"></div>
    </div>

    <!-- Weekly Tasks -->
    <div class="mb-6 p-4 border rounded-xl shadow-sm">
      <h2 class="text-xl font-semibold mb-3 text-green-700">Weekly Tasks</h2>
      <textarea id="weeklyTasks" rows="4" class="w-full border rounded-lg p-2"></textarea>
    </div>

    <!-- Monthly Tasks -->
    <div class="mb-6 p-4 border rounded-xl shadow-sm">
      <h2 class="text-xl font-semibold mb-3 text-purple-700">Monthly Tasks</h2>
      <textarea id="monthlyTasks" rows="4" class="w-full border rounded-lg p-2"></textarea>
    </div>

    <!-- Monitoring -->
    <div class="mb-6 p-4 border rounded-xl shadow-sm">
      <h2 class="text-xl font-semibold mb-3 text-red-700">Monitoring</h2>
      <label class="block mb-2">Mode:</label>
      <select id="monitoringMode" onchange="toggleMonitoringMode()" class="border rounded-lg p-2">
        <option value="auto">Auto Divide</option>
        <option value="manual">Manual Input</option>
      </select>

      <div id="autoDivideSection" class="mt-4">
        <label class="block mb-1">Start Time:</label>
        <input type="time" id="startTime" value="06:30" class="border rounded-lg p-2 w-full">
        <label class="block mb-1 mt-2">End Time:</label>
        <input type="time" id="endTime" value="14:30" class="border rounded-lg p-2 w-full">
        <label class="block mb-1 mt-2">Team Members (2-6):</label>
        <input type="number" id="teamCount" min="2" max="6" value="4" class="border rounded-lg p-2 w-full">
        <button onclick="generateMonitoring()" class="mt-3 px-4 py-2 bg-gray-300 rounded-lg">Generate Slots</button>
        <div id="autoMonitoringSlots" class="mt-3 space-y-2"></div>
      </div>

      <div id="manualSection" class="mt-4 hidden">
        <textarea id="manualMonitoring" rows="4" placeholder="Enter custom monitoring slots (e.g., 06:30-08:30)" class="w-full border rounded-lg p-2"></textarea>
        <button onclick="generateManualMonitoring()" class="mt-3 px-4 py-2 bg-gray-300 rounded-lg">Apply Manual Slots</button>
        <div id="manualMonitoringSlots" class="mt-3 space-y-2"></div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="text-center mb-6 space-x-4">
      <button id="resetBtn" class="px-6 py-3 bg-red-500 text-white rounded-xl shadow-lg hover:bg-red-600">Reset All</button>
    </div>
  </div>

<script>
  function toggleMonitoringMode() {
    const mode = document.getElementById("monitoringMode").value;
    document.getElementById("autoDivideSection").classList.toggle("hidden", mode !== "auto");
    document.getElementById("manualSection").classList.toggle("hidden", mode !== "manual");
  }
</script>
</body>
</html>
