<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IT Operations Task Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // ================= Firebase Setup =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC56asNTd04xhDU4OlnBHS4zNxj_aiiFhM",
      authDomain: "activity-log-275ce.firebaseapp.com",
      databaseURL: "https://activity-log-275ce-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "activity-log-275ce",
      storageBucket: "activity-log-275ce.firebasestorage.app",
      messagingSenderId: "436390670385",
      appId: "1:436390670385:web:a4e4bf77c32d4061c76510"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ================= Members =================
    const members = ["IRO","RDE","FFA","NLA","MAG","JMA"];

    // ================= Default Tasks =================
    let defaultTasks = ["PW","ARC","Loglogic","TM1Top","ISMS","CRITICAL","PROXY","HO","EMEA Ticket","TO","Remind AX"];
    let tasks = [...defaultTasks];

    // ================= Tab Navigation =================
    window.showTab = function(tab) {
      document.querySelectorAll(".tab-content").forEach(div => div.classList.add("hidden"));
      document.getElementById(tab).classList.remove("hidden");
    };

    // ================= Daily Tasks =================
    function loadTasks(state = {}) {
      const container = document.getElementById("dailyTasks");
      container.innerHTML = "";
      tasks.forEach(task => {
        const row = document.createElement("div");
        row.className = "flex items-center space-x-2";
        row.innerHTML = `
          <input type="checkbox" data-task="${task}" class="taskCheck">
          <label class="w-32">${task}</label>
          <select data-task="${task}" class="border p-1 rounded">
            <option value="">-- Assign --</option>
            ${members.map(m => `<option value="${m}">${m}</option>`).join("")}
          </select>
          <button data-remove="${task}" class="bg-red-500 text-white px-2 rounded">X</button>
        `;
        container.appendChild(row);
      });

      // restore state
      Object.entries(state).forEach(([task, val]) => {
        const cb = document.querySelector(`input[data-task="${task}"]`);
        const sel = document.querySelector(`select[data-task="${task}"]`);
        if (cb) cb.checked = val.checked;
        if (sel) sel.value = val.member;
      });

      // listeners
      document.querySelectorAll(".taskCheck").forEach(cb => {
        cb.addEventListener("change", () => {
          const task = cb.getAttribute("data-task");
          const member = document.querySelector(`select[data-task="${task}"]`).value;
          update(ref(db, "dailyTasks/" + task), { checked: cb.checked, member: member || "" });
        });
      });

      document.querySelectorAll("select[data-task]").forEach(sel => {
        sel.addEventListener("change", () => {
          const task = sel.getAttribute("data-task");
          const checked = document.querySelector(`input[data-task="${task}"]`).checked;
          update(ref(db, "dailyTasks/" + task), { checked: checked, member: sel.value || "" });
        });
      });

      document.querySelectorAll("button[data-remove]").forEach(btn => {
        btn.addEventListener("click", () => {
          const task = btn.getAttribute("data-remove");
          tasks = tasks.filter(t => t !== task);
          remove(ref(db, "dailyTasks/" + task));
          loadTasks(state);
        });
      });
    }

    // Add new Daily Task
    window.addTask = function() {
      const val = document.getElementById("newTask").value.trim();
      if (val && !tasks.includes(val)) {
        tasks.push(val);
        loadTasks();
        document.getElementById("newTask").value = "";
      }
    };

    // Realtime listener for Daily Tasks
    onValue(ref(db, "dailyTasks"), snap => {
      if (snap.exists()) loadTasks(snap.val());
      else loadTasks(); // show defaults if DB empty
    });

    // ================= Weekly / Monthly / Patching =================
    function setupTextSync(id) {
      const refPath = ref(db, id);
      onValue(refPath, snap => {
        document.getElementById(id + "Text").value = snap.exists() ? snap.val() : "";
      });
      window["save" + id] = function() {
        set(refPath, document.getElementById(id + "Text").value);
      };
    }

    setupTextSync("weekly");
    setupTextSync("monthly");
    setupTextSync("patching");

    // ================= Monitoring Schedule =================
    window.generateMonitoring = function() {
      const memberCount = members.length;
      const shifts = [
        "06:30 AM - 08:30 AM",
        "08:30 AM - 10:30 AM",
        "10:30 AM - 12:30 PM",
        "12:30 PM - 02:30 PM"
      ];

      let schedule = {};
      shifts.forEach((slot, i) => {
        schedule[slot] = members[i % memberCount];
      });

      set(ref(db, "monitoring"), schedule);
    };

    onValue(ref(db, "monitoring"), snap => {
      const container = document.getElementById("monitoringOutput");
      container.innerHTML = "";
      if (snap.exists()) {
        Object.entries(snap.val()).forEach(([slot, member]) => {
          const div = document.createElement("div");
          div.textContent = `${slot} - ${member}`;
          container.appendChild(div);
        });
      }
    });

    // ================= Generate Output =================
    window.generateOutput = function() {
      let output = "------ DAILY TASKS ------\n";
      onValue(ref(db, "dailyTasks"), snap => {
        if (snap.exists()) {
          Object.entries(snap.val()).forEach(([task, val]) => {
            if (val.checked) output += `${task} - ${val.member}\n`;
          });
        }
      }, { onlyOnce: true });

      output += "\n------ WEEKLY TASKS ------\n";
      output += document.getElementById("weeklyText").value + "\n";

      output += "\n------ MONTHLY TASKS ------\n";
      output += document.getElementById("monthlyText").value + "\n";

      output += "\n------ PATCHING TASKS ------\n";
      output += document.getElementById("patchingText").value + "\n";

      output += "\n------ MONITORING SCHEDULE ------\n";
      const monitor = document.getElementById("monitoringOutput").innerText;
      output += monitor;

      const timestamp = new Date().toLocaleString();
      output += `\n\nGenerated on: ${timestamp}`;

      document.getElementById("finalOutput").value = output;
      set(ref(db, "finalOutput"), output);
    };

    onValue(ref(db, "finalOutput"), snap => {
      if (snap.exists()) document.getElementById("finalOutput").value = snap.val();
    });

    // ================= Reset Everything =================
    window.resetAll = function() {
      remove(ref(db));
      document.getElementById("weeklyText").value = "";
      document.getElementById("monthlyText").value = "";
      document.getElementById("patchingText").value = "";
      document.getElementById("monitoringOutput").innerHTML = "";
      document.getElementById("finalOutput").value = "";
      tasks = [...defaultTasks];
      loadTasks();
    };

  </script>
</head>
<body class="p-6 font-sans bg-gray-50">
  <h1 class="text-2xl font-bold mb-4">IT Operations Task Manager</h1>

  <!-- Tabs -->
  <div class="flex space-x-2 border-b mb-4">
    <button onclick="showTab('daily')" class="px-4 py-2 bg-blue-500 text-white rounded-t">Daily</button>
    <button onclick="showTab('weekly')" class="px-4 py-2 bg-gray-200 rounded-t">Weekly</button>
    <button onclick="showTab('monthly')" class="px-4 py-2 bg-gray-200 rounded-t">Monthly</button>
    <button onclick="showTab('patching')" class="px-4 py-2 bg-gray-200 rounded-t">Patching</button>
    <button onclick="showTab('monitoring')" class="px-4 py-2 bg-gray-200 rounded-t">Monitoring</button>
    <button onclick="showTab('output')" class="px-4 py-2 bg-gray-200 rounded-t">Output</button>
  </div>

  <!-- Daily -->
  <div id="daily" class="tab-content">
    <h2 class="text-lg font-semibold mb-2">Daily Tasks</h2>
    <div id="dailyTasks" class="space-y-2"></div>
    <div class="mt-3 flex">
      <input id="newTask" placeholder="Add new task" class="border flex-1 p-1 rounded">
      <button onclick="addTask()" class="ml-2 bg-green-500 text-white px-3 rounded">Add</button>
    </div>
  </div>

  <!-- Weekly -->
  <div id="weekly" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">Weekly Tasks</h2>
    <textarea id="weeklyText" class="w-full border p-2 h-40" oninput="saveweekly()"></textarea>
  </div>

  <!-- Monthly -->
  <div id="monthly" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">Monthly Tasks</h2>
    <textarea id="monthlyText" class="w-full border p-2 h-40" oninput="savemonthly()"></textarea>
  </div>

  <!-- Patching -->
  <div id="patching" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">Patching Tasks</h2>
    <textarea id="patchingText" class="w-full border p-2 h-40" oninput="savepatching()"></textarea>
  </div>

  <!-- Monitoring -->
  <div id="monitoring" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">Monitoring Schedule</h2>
    <button onclick="generateMonitoring()" class="bg-blue-500 text-white px-4 py-2 rounded">Generate Monitoring Schedule</button>
    <div id="monitoringOutput" class="mt-3 space-y-1"></div>
  </div>

  <!-- Output -->
  <div id="output" class="tab-content hidden">
    <h2 class="text-lg font-semibold mb-2">Generated Output</h2>
    <button onclick="generateOutput()" class="bg-blue-500 text-white px-4 py-2 rounded mb-2">Generate Output</button>
    <button onclick="resetAll()" class="bg-red-500 text-white px-4 py-2 rounded mb-2">Reset</button>
    <textarea id="finalOutput" class="w-full border p-2 h-60"></textarea>
  </div>
</body>
</html>
