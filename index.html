<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IT Operations Task Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-5xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">IT Operations Task Generator</h1>

    <!-- Daily Tasks -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Daily Tasks</h2>
      <div id="dailyTasks" class="space-y-2"></div>
      <div class="mt-2">
        <input id="newTask" type="text" placeholder="Add new daily task" class="border p-2 rounded w-2/3">
        <button onclick="addTask()" class="bg-green-500 text-white px-4 py-2 rounded">Add</button>
      </div>
    </div>

    <!-- Weekly / Monthly / Patching Tasks -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Weekly Tasks</h2>
      <textarea id="weeklyTasks" class="border p-2 rounded w-full h-24"></textarea>
    </div>
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Monthly Tasks</h2>
      <textarea id="monthlyTasks" class="border p-2 rounded w-full h-24"></textarea>
    </div>
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Patching Tasks</h2>
      <textarea id="patchingTasks" class="border p-2 rounded w-full h-24"></textarea>
    </div>

    <!-- Monitoring -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Monitoring Schedule</h2>
      <div class="flex space-x-2 items-center mb-2">
        <label>Number of Members:</label>
        <input id="memberCount" type="number" min="2" max="6" value="4" class="border p-1 w-20 rounded">
        <button onclick="autoDivideMonitoring()" class="bg-purple-500 text-white px-4 py-2 rounded">Auto Divide</button>
      </div>
      <div id="monitoringSchedule" class="space-y-2"></div>
    </div>

    <!-- Buttons -->
    <div class="flex space-x-4">
      <button onclick="generateOutput()" class="bg-blue-500 text-white px-4 py-2 rounded">Generate Output</button>
      <button onclick="resetAll()" class="bg-red-500 text-white px-4 py-2 rounded">Reset</button>
    </div>

    <!-- Output -->
    <div class="mt-6">
      <h2 class="text-xl font-semibold mb-2">Generated Output</h2>
      <pre id="outputBox" class="border p-4 rounded bg-gray-50 whitespace-pre-wrap"></pre>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC56asNTd04xhDU4OlnBHS4zNxj_aiiFhM",
      authDomain: "activity-log-275ce.firebaseapp.com",
      databaseURL: "https://activity-log-275ce-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "activity-log-275ce",
      storageBucket: "activity-log-275ce.firebasestorage.app",
      messagingSenderId: "436390670385",
      appId: "1:436390670385:web:a4e4bf77c32d4061c76510"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const members = ["IRO", "RDE", "FFA", "NLA", "MAG", "JMA"];
    let tasks = ["PW", "ARC", "Loglogic", "TM1Top", "ISMS", "CRITICAL", "PROXY", "HO", "EMEA Ticket", "TO", "Remind AX"];
    const slots = [
      "06:30 AM - 08:30 AM",
      "08:30 AM - 10:30 AM",
      "10:30 AM - 12:30 PM",
      "12:30 PM - 02:30 PM"
    ];

    // Always load defaults
    loadTasks();
    loadMonitoring();

    // Daily Tasks UI
    function loadTasks(state = {}) {
      const container = document.getElementById("dailyTasks");
      container.innerHTML = "";
      tasks.forEach(task => {
        const row = document.createElement("div");
        row.className = "flex items-center space-x-2";
        row.innerHTML = `
          <input type="checkbox" data-task="${task}" class="taskCheck">
          <label class="w-32">${task}</label>
          <select data-task="${task}" class="border p-1 rounded">
            <option value="">-- Assign --</option>
            ${members.map(m => `<option value="${m}">${m}</option>`).join("")}
          </select>
        `;
        container.appendChild(row);
      });

      // restore state
      Object.entries(state).forEach(([task, val]) => {
        const cb = document.querySelector(`input[data-task="${task}"]`);
        const sel = document.querySelector(`select[data-task="${task}"]`);
        if (cb) cb.checked = val.checked;
        if (sel) sel.value = val.member;
      });

      // listeners
      document.querySelectorAll(".taskCheck").forEach(cb => {
        cb.addEventListener("change", () => {
          const task = cb.getAttribute("data-task");
          const member = document.querySelector(`select[data-task="${task}"]`).value;
          update(ref(db, "dailyTasks/" + task), { checked: cb.checked, member: member || "" });
        });
      });
      document.querySelectorAll("select[data-task]").forEach(sel => {
        sel.addEventListener("change", () => {
          const task = sel.getAttribute("data-task");
          const checked = document.querySelector(`input[data-task="${task}"]`).checked;
          update(ref(db, "dailyTasks/" + task), { checked: checked, member: sel.value || "" });
        });
      });
    }

    // Add new Daily Task
    window.addTask = function() {
      const val = document.getElementById("newTask").value.trim();
      if (val && !tasks.includes(val)) {
        tasks.push(val);
        loadTasks();
        document.getElementById("newTask").value = "";
      }
    };

    // Monitoring UI
    function loadMonitoring(state = {}) {
      const container = document.getElementById("monitoringSchedule");
      container.innerHTML = "";
      slots.forEach((slot, i) => {
        const row = document.createElement("div");
        row.className = "flex items-center space-x-2";
        row.innerHTML = `
          <label class="w-40">${slot}</label>
          <select data-slot="${i}" class="border p-1 rounded">
            <option value="">-- Select Member --</option>
            ${members.map(m => `<option value="${m}">${m}</option>`).join("")}
          </select>
        `;
        container.appendChild(row);
      });

      // restore state
      Object.entries(state).forEach(([i, val]) => {
        const sel = document.querySelector(`select[data-slot="${i}"]`);
        if (sel) sel.value = val.member || "";
      });

      // listeners
      document.querySelectorAll("select[data-slot]").forEach(sel => {
        sel.addEventListener("change", () => {
          const i = sel.getAttribute("data-slot");
          update(ref(db, "monitoring/" + i), { member: sel.value || "" });
        });
      });
    }

    // Auto Divide Monitoring
    window.autoDivideMonitoring = function() {
      const count = parseInt(document.getElementById("memberCount").value) || 4;
      const chosen = members.slice(0, count);
      const assignment = {};
      slots.forEach((slot, i) => {
        const member = chosen[i % count];
        assignment[i] = { member };
      });
      set(ref(db, "monitoring"), assignment);
    };

    // Weekly/Monthly/Patching realtime save
    document.getElementById("weeklyTasks").addEventListener("input", e => {
      set(ref(db, "weekly"), { text: e.target.value });
    });
    document.getElementById("monthlyTasks").addEventListener("input", e => {
      set(ref(db, "monthly"), { text: e.target.value });
    });
    document.getElementById("patchingTasks").addEventListener("input", e => {
      set(ref(db, "patching"), { text: e.target.value });
    });

    // Generate Output
    window.generateOutput = async function() {
      const checkedTasks = [];
      document.querySelectorAll(".taskCheck").forEach(cb => {
        if (cb.checked) {
          const task = cb.getAttribute("data-task");
          const member = document.querySelector(`select[data-task="${task}"]`).value || "Unassigned";
          checkedTasks.push(`${task} - ${member}`);
        }
      });

      const weekly = document.getElementById("weeklyTasks").value;
      const monthly = document.getElementById("monthlyTasks").value;
      const patching = document.getElementById("patchingTasks").value;

      const monitoring = [];
      document.querySelectorAll("select[data-slot]").forEach(sel => {
        const slot = slots[sel.getAttribute("data-slot")];
        const member = sel.value || "Unassigned";
        monitoring.push(`${slot} - ${member}`);
      });

      const output = `
------ Daily Tasks ------
${checkedTasks.join("\n") || "None selected"}

------ Weekly Tasks ------
${weekly || "None"}

------ Monthly Tasks ------
${monthly || "None"}

------ Patching Tasks ------
${patching || "None"}

------ Monitoring ------
${monitoring.join("\n")}
      `;

      document.getElementById("outputBox").innerText = output;
      await set(ref(db, "generatedOutput"), { text: output });
    };

    // Reset All
    window.resetAll = function() {
      set(ref(db, "dailyTasks"), {});
      set(ref(db, "weekly"), { text: "" });
      set(ref(db, "monthly"), { text: "" });
      set(ref(db, "patching"), { text: "" });
      set(ref(db, "monitoring"), {});
      set(ref(db, "generatedOutput"), { text: "" });
    };

    // Realtime Listeners
    onValue(ref(db, "dailyTasks"), snapshot => loadTasks(snapshot.val() || {}));
    onValue(ref(db, "monitoring"), snapshot => loadMonitoring(snapshot.val() || {}));
    onValue(ref(db, "weekly"), snapshot => document.getElementById("weeklyTasks").value = snapshot.val()?.text || "");
    onValue(ref(db, "monthly"), snapshot => document.getElementById("monthlyTasks").value = snapshot.val()?.text || "");
    onValue(ref(db, "patching"), snapshot => document.getElementById("patchingTasks").value = snapshot.val()?.text || "");
    onValue(ref(db, "generatedOutput"), snapshot => document.getElementById("outputBox").innerText = snapshot.val()?.text || "");
  </script>
</body>
</html>
