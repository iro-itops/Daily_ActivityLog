<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>IT Operations Task Manager (Realtime)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab-active { background-color:#2563eb; color:white; }
    .tab-inactive { background:#f3f4f6; color:#111827; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-6 font-sans">
  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow p-6">
    <header class="flex items-start gap-4 mb-6">
      <h1 class="text-2xl font-bold">IT Operations Task Manager (Realtime)</h1>
      <div class="ml-auto">
        <button id="resetBtn" class="bg-red-500 text-white px-3 py-2 rounded">Reset All</button>
      </div>
    </header>

    <!-- tabs -->
    <div class="flex gap-2 mb-4" id="tabs">
      <button id="tab-daily" class="px-4 py-2 rounded tab-active" onclick="showTab('daily')">Daily</button>
      <button id="tab-weekly" class="px-4 py-2 rounded tab-inactive" onclick="showTab('weekly')">Weekly</button>
      <button id="tab-monthly" class="px-4 py-2 rounded tab-inactive" onclick="showTab('monthly')">Monthly</button>
      <button id="tab-patching" class="px-4 py-2 rounded tab-inactive" onclick="showTab('patching')">Patching</button>
      <button id="tab-monitoring" class="px-4 py-2 rounded tab-inactive" onclick="showTab('monitoring')">Monitoring</button>
      <button id="tab-output" class="px-4 py-2 rounded tab-inactive" onclick="showTab('output')">Output</button>
    </div>

    <!-- DAILY -->
    <section id="daily" class="tab-content">
      <h2 class="text-lg font-semibold mb-3">Daily Tasks (per shift)</h2>

      <div class="flex items-center gap-3 mb-3">
        <label class="font-medium">Shift:</label>
        <select id="dailyShiftSelect" class="border rounded p-2">
          <option value="shift1">1st shift (06:30 - 14:30)</option>
          <option value="shift2">2nd shift (14:30 - 22:30)</option>
          <option value="shift3">3rd shift (22:30 - 06:30)</option>
        </select>

        <div class="ml-auto flex items-center gap-2">
          <label class="font-medium">Add Member:</label>
          <input id="newMemberKey" placeholder="TRI (e.g. IRO)" class="border p-2 rounded w-24" />
          <input id="newMemberName" placeholder="Full name" class="border p-2 rounded w-48" />
          <button id="btnAddMember" class="bg-green-600 text-white px-3 py-2 rounded">Add</button>
        </div>
      </div>

      <div id="dailyTasks" class="space-y-2 mb-3"></div>

      <div class="flex gap-2">
        <input id="newTask" class="flex-1 border rounded p-2" placeholder="Add new task (e.g. PW)" />
        <button id="btnAddTask" class="bg-green-500 text-white px-4 py-2 rounded">Add</button>
      </div>
    </section>

    <!-- WEEKLY -->
    <section id="weekly" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">Weekly Tasks (free-text)</h2>
      <textarea id="weeklyText" class="w-full border rounded p-3 h-40" placeholder="Type weekly tasks..."></textarea>
    </section>

    <!-- MONTHLY -->
    <section id="monthly" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">Monthly Tasks (free-text)</h2>
      <textarea id="monthlyText" class="w-full border rounded p-3 h-40" placeholder="Type monthly tasks..."></textarea>
    </section>

    <!-- PATCHING -->
    <section id="patching" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-2">Patching Tasks (free-text)</h2>
      <textarea id="patchingText" class="w-full border rounded p-3 h-40" placeholder="Type patching tasks..."></textarea>
    </section>

    <!-- MONITORING -->
    <section id="monitoring" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-3">Monitoring</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <!-- shift1 -->
        <div class="border p-4 rounded">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">1st Shift (06:30 - 14:30)</h3>
            <div>
              <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="generateShift('shift1')">Generate</button>
              <button class="ml-2 bg-gray-200 px-2 py-1 rounded" onclick="clearShift('shift1')">Clear</button>
            </div>
          </div>
          <div id="shift1-members" class="mt-3 space-y-1"></div>
          <div id="shift1-slots" class="mt-3 space-y-2"></div>
        </div>

        <!-- shift2 -->
        <div class="border p-4 rounded">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">2nd Shift (14:30 - 22:30)</h3>
            <div>
              <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="generateShift('shift2')">Generate</button>
              <button class="ml-2 bg-gray-200 px-2 py-1 rounded" onclick="clearShift('shift2')">Clear</button>
            </div>
          </div>
          <div id="shift2-members" class="mt-3 space-y-1"></div>
          <div id="shift2-slots" class="mt-3 space-y-2"></div>
        </div>

        <!-- shift3 -->
        <div class="border p-4 rounded">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">3rd Shift (22:30 - 06:30)</h3>
            <div>
              <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="generateShift('shift3')">Generate</button>
              <button class="ml-2 bg-gray-200 px-2 py-1 rounded" onclick="clearShift('shift3')">Clear</button>
            </div>
          </div>
          <div id="shift3-members" class="mt-3 space-y-1"></div>
          <div id="shift3-slots" class="mt-3 space-y-2"></div>
        </div>
      </div>
      <p class="text-sm text-gray-600 mt-3">Select members present for the shift then click Generate. You may override any slot from the dropdown (realtime).</p>
    </section>

    <!-- OUTPUT -->
    <section id="output" class="tab-content hidden">
      <h2 class="text-lg font-semibold mb-3">Generated Output</h2>
      <div class="flex gap-2 mb-3">
        <button id="btnGenerateOutput" class="bg-indigo-600 text-white px-4 py-2 rounded">Generate Output</button>
        <button id="btnCopy" class="bg-gray-200 px-4 py-2 rounded">Copy</button>
        <button id="btnDownload" class="bg-gray-200 px-4 py-2 rounded">Download .txt</button>
      </div>
      <textarea id="finalOutput" class="w-full border rounded p-3 h-64"></textarea>
    </section>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, remove, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // === Firebase config (kept as requested) ===
    const firebaseConfig = {
      apiKey: "AIzaSyC56asNTd04xhDU4OlnBHS4zNxj_aiiFhM",
      authDomain: "activity-log-275ce.firebaseapp.com",
      databaseURL: "https://activity-log-275ce-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "activity-log-275ce",
      storageBucket: "activity-log-275ce.firebasestorage.app",
      messagingSenderId: "436390670385",
      appId: "1:436390670385:web:a4e4bf77c32d4061c76510"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // defaults
    const DEFAULT_MEMBERS = { IRO: "Ian Romero", RDE: "Rhizza De Guzman", FFA: "Felix Factor", NLA: "Nathan Lapena", MAG: "Michael Henry Aglubat", JMA: "Jelyn Malubay" };
    const DEFAULT_DAILY = {
      shift1: ["PW","ARC","Loglogic","TM1Top","ISMS","CRITICAL","PROXY","HO","EMEA","TO"],
      shift2: ["PW","ARC","ISMS","TO","EMEA"],
      shift3: ["PW","ARC","TICKET CLEANUP","SC01 SC02 BACKUP","EMEA","SSRS","UNK_EMAIL","TO"]
    };

    // small selectors
    const el = id => document.getElementById(id);
    const els = sel => Array.from(document.querySelectorAll(sel));

    // Tab helper
    function setActiveTab(name) {
      els('.tab-content').forEach(d => d.classList.add('hidden'));
      el(name).classList.remove('hidden');
      ['daily','weekly','monthly','patching','monitoring','output'].forEach(n=>{
        const btn = el('tab-'+n);
        if (!btn) return;
        if (n === name) { btn.classList.add('tab-active'); btn.classList.remove('tab-inactive'); }
        else { btn.classList.remove('tab-active'); btn.classList.add('tab-inactive'); }
      });
    }
    window.showTab = setActiveTab;

    // Seed defaults when DB empty
    async function ensureDefaults() {
      // teamMembers
      const teamRef = ref(db, 'teamMembers');
      const teamSnap = await get(teamRef);
      if (!teamSnap.exists()) {
        await set(teamRef, DEFAULT_MEMBERS);
      }
      // daily tasks per shift
      const dailyRef = ref(db, 'dailyTasks');
      const dailySnap = await get(dailyRef);
      if (!dailySnap.exists()) {
        const payload = {};
        Object.entries(DEFAULT_DAILY).forEach(([shift, arr])=>{
          payload[shift] = {};
          arr.forEach(t => payload[shift][t] = { checked:false, member:"" });
        });
        await set(dailyRef, payload);
      }
      // monitoringSchedules
      const msRef = ref(db, 'monitoringSchedules');
      const msSnap = await get(msRef);
      if (!msSnap.exists()) {
        const base = {
          shift1: { start:"06:30", end:"14:30", members:{}, slots:{} },
          shift2: { start:"14:30", end:"22:30", members:{}, slots:{} },
          shift3: { start:"22:30", end:"06:30", members:{}, slots:{} }
        };
        await set(msRef, base);
      }
      // weekly/monthly/patching/finalOutput keys
      if (!(await get(ref(db,'weekly'))).exists()) await set(ref(db,'weekly'), "");
      if (!(await get(ref(db,'monthly'))).exists()) await set(ref(db,'monthly'), "");
      if (!(await get(ref(db,'patching'))).exists()) await set(ref(db,'patching'), "");
      if (!(await get(ref(db,'finalOutput'))).exists()) await set(ref(db,'finalOutput'), "");
    }

    // ---------- Team members UI & sync ----------
    onValue(ref(db, 'teamMembers'), snap => {
      const map = snap.exists() ? snap.val() : DEFAULT_MEMBERS;
      window._membersMap = map;
      // populate checkboxes in each shift members area
      ['shift1','shift2','shift3'].forEach(shiftId => {
        const container = el(shiftId + '-members');
        container.innerHTML = '';
        Object.entries(map).forEach(([k,v])=>{
          const id = `${shiftId}-m-${k}`;
          const wrapper = document.createElement('div');
          wrapper.className = 'flex items-center gap-2';
          wrapper.innerHTML = `<input type="checkbox" id="${id}" data-key="${k}" /> <label for="${id}" class="text-sm">${k} — ${v}</label>`;
          container.appendChild(wrapper);
        });
      });
      // update dropdowns if present
      els('select[data-slot]').forEach(sel => {
        const cur = sel.value;
        sel.innerHTML = `<option value="">-- Select --</option>` + Object.entries(map).map(([k,v])=>`<option value="${k}">${k} (${v})</option>`).join('');
        if (cur) sel.value = cur;
      });
    });

    // Add member
    el('btnAddMember').addEventListener('click', async () => {
      const key = el('newMemberKey').value.trim().toUpperCase();
      const name = el('newMemberName').value.trim();
      if (!key || !name) return alert('Enter trigram and full name');
      const mRef = ref(db, `teamMembers/${key}`);
      await set(mRef, name);
      el('newMemberKey').value = ''; el('newMemberName').value = '';
    });

    // ---------- Daily tasks rendering & realtime ----------
    onValue(ref(db, 'dailyTasks'), snap => {
      const data = snap.exists() ? snap.val() : {};
      const shift = el('dailyShiftSelect').value;
      renderDailyShift(shift, data[shift] || {});
    });

    // when shift select changed -> render that shift's tasks
    el('dailyShiftSelect').addEventListener('change', async () => {
      const dataSnap = (await get(ref(db,'dailyTasks'))).val() || {};
      const shift = el('dailyShiftSelect').value;
      renderDailyShift(shift, dataSnap[shift] || {});
    });

    function renderDailyShift(shiftId, items) {
      const container = el('dailyTasks');
      container.innerHTML = '';
      // tasks order: DB keys or default list
      const keys = items && Object.keys(items).length ? Object.keys(items) : (DEFAULT_DAILY[shiftId] || []);
      keys.forEach(task => {
        const st = items[task] || { checked:false, member:"" };
        const row = document.createElement('div');
        row.className = 'flex items-center gap-3';
        row.innerHTML = `
          <input type="checkbox" data-task="${task}" ${st.checked ? 'checked' : ''} />
          <div class="flex-1"><div class="font-medium">${task}</div></div>
          <select data-task="${task}" class="border rounded p-1"></select>
          <button data-remove="${task}" class="ml-2 bg-red-500 text-white px-2 py-1 rounded">Remove</button>
        `;
        container.appendChild(row);
        // populate member dropdown
        const sel = row.querySelector('select[data-task]');
        const memObj = window._membersMap || DEFAULT_MEMBERS;
        sel.innerHTML = `<option value="">-- Assign --</option>` + Object.entries(memObj).map(([k,v])=>`<option value="${k}">${k} (${v})</option>`).join('');
        sel.value = st.member || '';
      });

      // listeners
      els('#dailyTasks input[type=checkbox]').forEach(cb => {
        cb.onchange = () => {
          const task = cb.getAttribute('data-task');
          const shift = el('dailyShiftSelect').value;
          const member = document.querySelector(`select[data-task="${task}"]`).value || "";
          set(ref(db, `dailyTasks/${shift}/${task}`), { checked: cb.checked, member });
        };
      });
      els('#dailyTasks select[data-task]').forEach(sel => {
        sel.onchange = () => {
          const task = sel.getAttribute('data-task');
          const shift = el('dailyShiftSelect').value;
          const checked = document.querySelector(`#dailyTasks input[data-task="${task}"]`)?.checked || false;
          set(ref(db, `dailyTasks/${shift}/${task}`), { checked, member: sel.value || "" });
        };
      });
      els('#dailyTasks button[data-remove]').forEach(btn => {
        btn.onclick = async () => {
          const task = btn.getAttribute('data-remove');
          const shift = el('dailyShiftSelect').value;
          await remove(ref(db, `dailyTasks/${shift}/${task}`));
        };
      });
    }

    // Add Daily Task (for selected shift)
    el('btnAddTask').addEventListener('click', async () => {
      const val = el('newTask').value.trim();
      if (!val) return;
      const shift = el('dailyShiftSelect').value;
      await set(ref(db, `dailyTasks/${shift}/${val}`), { checked:false, member:"" });
      el('newTask').value = '';
    });

    // ---------- Weekly/Monthly/Patching realtime sync ----------
    function watchText(key, elId) {
      onValue(ref(db, key), snap => {
        const v = snap.exists() ? snap.val() : '';
        if (el(elId).value !== v) el(elId).value = v;
      });
      el(elId).addEventListener('input', e => set(ref(db, key), e.target.value));
    }
    watchText('weekly','weeklyText');
    watchText('monthly','monthlyText');
    watchText('patching','patchingText');

    // ---------- Monitoring: render shift (members & slots) ----------
    async function renderShift(shiftId) {
      const snap = await get(ref(db, `monitoringSchedules/${shiftId}`));
      const shiftData = snap.exists() ? snap.val() : { start:(shiftId==='shift1'?'06:30':shiftId==='shift2'?'14:30':'22:30'), end:(shiftId==='shift1'?'14:30':shiftId==='shift2'?'22:30':'06:30'), members:{}, slots:{} };

      // set checkboxes (already created by teamMembers watcher) - mark according to shiftData.members
      els(`#${shiftId}-members input[type=checkbox]`).forEach(cb => {
        const key = cb.getAttribute('data-key');
        cb.checked = !!shiftData.members?.[key];
      });

      // render slots
      const slotsContainer = el(shiftId + '-slots');
      slotsContainer.innerHTML = '';
      const slots = shiftData.slots || {};
      if (!Object.keys(slots).length) {
        slotsContainer.innerHTML = '<div class="text-sm text-gray-500">No slots yet. Click Generate to auto-divide.</div>';
        return;
      }
      // create row per slot
      Object.entries(slots).forEach(([slotTime, sData]) => {
        const row = document.createElement('div');
        row.className = 'flex gap-3 items-center';
        row.innerHTML = `<div class="w-56 text-sm">${slotTime}</div><select data-slot="${shiftId}|${slotTime}" class="border rounded p-1"></select>`;
        slotsContainer.appendChild(row);
        const sel = row.querySelector('select');
        const memObj = window._membersMap || DEFAULT_MEMBERS;
        sel.innerHTML = `<option value="">-- Select --</option>` + Object.entries(memObj).map(([k,v])=>`<option value="${k}">${k} (${v})</option>`).join('');
        sel.value = sData?.member || '';
        sel.onchange = () => set(ref(db, `monitoringSchedules/${shiftId}/slots/${slotTime}`), { member: sel.value || "" });
      });
    }

    // realtime watchers for monitoring schedules -> re-render shift
    onValue(ref(db, 'monitoringSchedules/shift1'), snap => renderShift('shift1'));
    onValue(ref(db, 'monitoringSchedules/shift2'), snap => renderShift('shift2'));
    onValue(ref(db, 'monitoringSchedules/shift3'), snap => renderShift('shift3'));

    // generate shift slots (auto-divide) — uses who is checked in the shift-members section
    function toDate(hm) { const [hh,mm] = hm.split(':').map(Number); const d = new Date(); d.setHours(hh,mm,0,0); return d; }
    function fmtTime(d) { let h = d.getHours(), m = d.getMinutes(), am = h>=12?'PM':'AM'; h = h%12||12; return `${String(h).padStart(2,'')}:${String(m).padStart(2,'0')} ${am}`; }

    window.generateShift = async function(shiftId) {
      // collect checked members for this shift
      const checked = els(`#${shiftId}-members input[type=checkbox]`).filter(cb=>cb.checked).map(cb=>cb.getAttribute('data-key'));
      if (!checked.length) return alert('No members selected for this shift.');
      // shift times mapping
      const times = { shift1:{s:'06:30', e:'14:30'}, shift2:{s:'14:30', e:'22:30'}, shift3:{s:'22:30', e:'06:30'} };
      const {s:eStart, e:eEnd} = {s:times[shiftId].s, e:times[shiftId].e}; // fix var naming
      const start = toDate(times[shiftId].s);
      let end = toDate(times[shiftId].e);
      if (end <= start) end = new Date(end.getTime() + 24*60*60*1000);
      const totalMin = (end - start) / 60000;
      const parts = checked.length;
      const slotMin = totalMin / parts;
      const slots = [];
      let cur = new Date(start);
      for (let i=0;i<parts;i++) {
        const s = new Date(cur);
        cur.setMinutes(cur.getMinutes() + slotMin);
        const e = new Date(cur);
        slots.push(`${fmtTime(s)} - ${fmtTime(e)}`);
      }
      // build slots object keyed by label -> { member: trigram }
      const slotsObj = {};
      slots.forEach((label, idx) => {
        slotsObj[label] = { member: checked[idx] || "" };
      });
      const membersObj = {}; checked.forEach(k => membersObj[k] = true);
      await set(ref(db, `monitoringSchedules/${shiftId}`), { start: times[shiftId].s, end: times[shiftId].e, members: membersObj, slots: slotsObj });
      // onValue listener will re-render
    };

    window.clearShift = async function(shiftId) {
      await set(ref(db, `monitoringSchedules/${shiftId}`), { start:(shiftId==='shift1'?'06:30':shiftId==='shift2'?'14:30':'22:30'), end:(shiftId==='shift1'?'14:30':shiftId==='shift2'?'22:30':'06:30'), members:{}, slots:{} });
    };

    // ---------- Generate Output / Copy / Download ----------
    el('btnGenerateOutput').addEventListener('click', async () => {
      const snapshot = await get(ref(db));
      const data = snapshot.exists() ? snapshot.val() : {};
      let out = `IT OPERATIONS TASKS REPORT\nGenerated: ${new Date().toLocaleString()}\n\n`;
      out += '--- DAILY TASKS ---\n';
      const daily = data.dailyTasks || {};
      Object.entries(daily).forEach(([shift, tasks])=>{
        out += `\n[${shift}]\n`;
        Object.entries(tasks).forEach(([t, info])=> out += `${t} — ${info.member || 'Unassigned'} — ${info.checked ? 'Done' : 'Pending'}\n`);
      });
      out += `\n--- WEEKLY ---\n${data.weekly || ''}\n\n--- MONTHLY ---\n${data.monthly || ''}\n\n--- PATCHING ---\n${data.patching || ''}\n\n--- MONITORING ---\n`;
      const sched = data.monitoringSchedules || {};
      Object.entries(sched).forEach(([shiftId, shift])=>{
        out += `\n${shiftId.toUpperCase()} (${shift.start} - ${shift.end})\n`;
        const s = shift.slots || {};
        Object.entries(s).forEach(([label, info]) => out += `${label} — ${info.member || 'Unassigned'}\n`);
      });
      el('finalOutput').value = out;
      await set(ref(db, 'finalOutput'), out);
    });

    // copy to clipboard
    el('btnCopy').addEventListener('click', async ()=>{
      const text = el('finalOutput').value;
      if (!text) return alert('No output to copy. Generate first.');
      await navigator.clipboard.writeText(text);
      alert('Copied to clipboard');
    });

    // download file
    el('btnDownload').addEventListener('click', ()=> {
      const text = el('finalOutput').value || '';
      const blob = new Blob([text], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `itops-report-${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // watch finalOutput in DB so everyone sees latest generated output
    onValue(ref(db,'finalOutput'), snap => { if (snap.exists()) el('finalOutput').value = snap.val(); });

    // ---------- Reset All button ----------
    el('resetBtn').addEventListener('click', async () => {
      if (!confirm('Reset ALL data in Firebase? This clears tasks, schedules, members, and texts.')) return;
      await remove(ref(db));
      await ensureDefaults();
      alert('Reset done and defaults restored.');
    });

    // ---------- app init ----------
    (async function init() {
      await ensureDefaults();
      setActiveTab('daily');
      // initial renders
      renderShift('shift1');
      renderShift('shift2');
      renderShift('shift3');
    })();

  </script>
</body>
</html>
